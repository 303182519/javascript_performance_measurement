<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OneHeap</title>
    <link rel="stylesheet" href="../lib/vis.css">
    <style>
        #root {
            height: 600px;
            border: 1px solid;
        }
    </style>
</head>
<body>
<p id="tips">请耐心等待
    <progress id="progress"></progress>
</p>
<div id="root"></div>
</body>
<script src="../lib/jquery-2.1.4.min.js"></script>
<script src="../lib/vis.min.js"></script>
<script src="../lib/underscore-min.js"></script>
<script type="text/javascript">
    $.getJSON("sample.heapsnapshot", function (root) {

        console.time('process_data');

        /**
         * invert key and value of an array of string
         *
         * ["a","b","c"] => {
         *   "a":0,
         *   "b":1,
         *   "c":2
         * }
         *
         **/
        function key_invert(arr) {
            var ret = {};
            for (var i = 0; i < arr.length; i++) {
                ret[arr[i]] = i;
            }
            return ret;
        }


        var META = root.snapshot.meta;
        var NAMING = {
            NODE_FIELDS: key_invert(META.node_fields),
            EDGE_FIELDS: key_invert(META.edge_fields),
            NODE_TYPES: key_invert(META.node_types[0]),
            EDGE_TYPES: key_invert(META.edge_types[0])
        }
        var EDGE_FIELDS_LENGTH = META.edge_fields.length;

        console.debug("root: %o meta: %o NAMING: %o",
                root, root.snapshot.meta, NAMING);

        var n = root.nodes;
        var s = root.strings;
        var e = root.edges;

        var NODES_MAP = window.N = {}
        var EDGES_ARRAY = window.E = [];

        var edge_offset = 0;

        for (var i = 0; i < n.length; i += META.node_fields.length) {
            var i_type = n[i];
            var i_name = s[n[i + 1]];
            var i_id = n[i + 2];
            var i_size = n[i + 3]
            var i_edge_count = n[i + 4];

            var node = {
                id: i_id,
                group: i_type,
                label: i_name + "@" + i_id,
                shape: 'dot'
            }

            for (var j = 0; j < i_edge_count; j++) {
                var base = edge_offset + j * EDGE_FIELDS_LENGTH;
                var e_type = e[base];
                var e_prop;
                var e_to = e[base + 2];

                /**
                 * @link https://github.com/joyent/node/blob/d13d7f74d794340ac5e126cfb4ce507fe0f803d5/deps/v8/src/heap-snapshot-generator.cc#L2874
                 **/

                if (e_type === 1 || e_type === 4) {
                    e_prop = "[" + e[base + 1] + "]";
                } else {
                    e_prop = s[e[base + 1]];
                }

                var e_found = {
                    id: base,
                    from: i_id,
                    to: n[e_to + 2],
                    group: e_type,
                    arrows: 'to',
                    title: META.edge_types[0][e_type],
                    label: e_prop
                };

                EDGES_ARRAY.push(e_found);
            }

            edge_offset += EDGE_FIELDS_LENGTH * i_edge_count;
            NODES_MAP[i_id] = node;
        }

        /**
         * hidden: "0"
         * array: "1"
         * string: "2"
         * object: "3"
         * code: "4"
         * closure: "5"
         * regexp: "6"
         * number: "7"
         * native: "8"
         * synthetic: "9"
         */

        var count = 0;
        var nodes = _.filter(NODES_MAP, function (n) {

            if ([8, 9].indexOf(n.group) !== -1) {
                return true;
            }

            if (n.id < 32) {
                return true;
            }

        })

        var node_id = _.map(nodes, function (i) {
            return i.id
        });

        var edges = _.filter(EDGES_ARRAY, function (i) {

            if (_.indexOf(node_id, i.from) !== -1) {
                return true;
            } else if (_.indexOf(node_id, i.to) !== -1) {
                return true;
            }

            return false;
        })


//        es = _.where(es, {
//            group: 2
//        });

        // create a network
        var container = document.getElementById('root');
        var data = {
            nodes: nodes,
            edges: edges
        };

        /**
         * context: "0"
         * element: "1"
         * hidden: "4"
         * internal: "3"
         * property: "2"
         * shortcut: "5"
         * weak: "6"
         */
        var options = {
            groups: {
                6: {
                    color: "red"
                },
                8: {
                    color: "pink"
                },
                9: {
                    color: "gray"
                }
            }
        };

        console.timeEnd('process_data');

        console.info('rendering %d nodes and %d egdes', nodes.length, edges.length);

        var network = new vis.Network(container, data, options);

        network.on('stabilizationProgress', function (e) {
            $("#progress").val(e.iterations / e.total);
        });

        network.on('stabilizationIterationsDone', function (e) {
            $("#tips").hide();
        });
    });

</script>
</html>
