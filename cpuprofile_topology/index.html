<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>CPU Profile Topology</title>
    <link rel="stylesheet" href="../lib/vis.css">
    <script src="../lib/jquery-2.1.3.js"></script>
    <script src="../lib/vis.js"></script>
    <style type="text/css">
        #mynetwork {
            border: 1px solid lightgray;
        }
    </style>
</head>
<body>
<div id="topology">
    <img src="../images/indicator_medium.gif" alt="加载中"/>
</div>

<script type="text/javascript">


    $.getJSON("sample.cpuprofile", function (result) {

        var PATH_CACHE = {};
        var CLEANUP = null;

        /**
         *
         * travers all nodes, initialize vis, update PATH cache
         *
         * @param node begin node
         * @param vis_nodes VIS
         * @param vis_edges VIS
         * @param paths current path
         */
        function traverse(node, vis_nodes, vis_edges, paths) {

            if (!vis_nodes.get(node.callUID)) {
                vis_nodes.add({
                    id: node.callUID,
                    label: node.functionName,
                    font: {
                        color: "white"
                    },
                    color: "gray"
                })
            }

            paths.push(node.callUID);

            PATH_CACHE[Object.keys(PATH_CACHE).length + 1] = paths.slice();

            if (node.children) {
                for (var i = 0; i < node.children.length; i++) {
                    var child = node.children[i];

                    var exist = vis_edges.get({
                        filter: function (item) {
                            return (item.from == node.callUID) && (item.to == child.callUID);
                        }
                    })


                    if (exist.length === 0) {
                        vis_edges.add({
                            arrows: "to",
                            from: node.callUID,
                            to: child.callUID,
                            color: "gray"
                        })
                    }


                    // depth first
                    traverse(child, vis_nodes, vis_edges, paths.slice());
                }
            }
        }

        // create an array with nodes
        var nodes = new vis.DataSet();

        // create an array with edges
        var edges = new vis.DataSet();

        // create a network
        var container = document.getElementById('topology');

        traverse(result.head, nodes, edges, []);

        var data = {
            nodes: nodes,
            edges: edges
        };

        var options = {
            width: "100%",
            height: "600px"
        };

        var network = new vis.Network(container, data, options);

        $("#time").attr({
            min: result.timestamps[0],
            max: result.timestamps[result.timestamps.length - 1],
        }).mousemove(function () {
            var selected = $(this).val();
            for (var i = 0; i < result.timestamps.length; i++) {
                if (selected <= result.timestamps[i]) {
                    $("#time_text").text("time:" + (result.timestamps[i] - result.timestamps[0]) / 1E3 + "  ms active_path:" + result.samples[i]);


                    // first,revert colors
                    var node_in_path = nodes.get(CLEANUP);

                    node_in_path.forEach(function (item) {
                        item.color = "gray";
                    });

                    nodes.update(node_in_path);

                    // second, update lines
                    var node_in_path = nodes.get(PATH_CACHE[result.samples[i]]);

                    node_in_path.forEach(function (item) {
                        item.color = "blue";
                    });

                    nodes.update(node_in_path);

                    CLEANUP = PATH_CACHE[result.samples[i]].slice();

                    break;
                }
            }
        }).trigger('change');
    })
</script>
<form>
    <label>
        <span id="time_text"></span><br/>

        <div><input id="time" type="range" step="1" style="width: 726px"/></div>
        <div><img src="./screenshot_chrome.png"></div>
    </label>
</form>
</body>
</html>